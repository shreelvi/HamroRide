@model gurujiRide.Models.RideRequest

@using System.Text.RegularExpressions

<div class="card ride-card" style="margin:8px;" title="@((Model.Name ?? "") + " — " + (Model.Contact ?? ""))">
  <div class="card-body">
    <h5 class="card-title" title="@Model.Name">@Html.Encode(Model.Name ?? "Anonymous")</h5>

    @{ 
        var contactRaw = Model.Contact ?? string.Empty;
        var contactDisplay = Html.Encode(contactRaw);
        string? href = null;
        if (!string.IsNullOrWhiteSpace(contactRaw))
        {
            // If already a URL, use as-is
            if (contactRaw.StartsWith("http", StringComparison.OrdinalIgnoreCase))
            {
                href = contactRaw;
            }
            else if (contactRaw.StartsWith("m.me", StringComparison.OrdinalIgnoreCase) || contactRaw.Contains("m.me"))
            {
                // Facebook messenger shortlink
                href = "https://" + contactRaw;
            }
            else if (Regex.IsMatch(contactRaw, "^[\\d\\+\\-\\s\\(\\)]+$"))
            {
                // Looks like a phone number — open with tel:
                href = "tel:" + contactRaw.Replace(" ", "");
            }
            else if (contactRaw.Contains("@"))
            {
                href = "mailto:" + contactRaw;
            }
            else
            {
                // Fallback: assume it's a host/path and open with https
                href = "https://" + contactRaw;
            }
        }

        // Whitelist of safe hosts for external links (only allow messenger-related hosts or explicit protocols)
        var allowedHosts = new[] { "m.me", "messenger.com", "www.messenger.com", "facebook.com", "www.facebook.com" };
        bool linkAllowed = false;
        if (!string.IsNullOrEmpty(href))
        {
            if (href.StartsWith("tel:") || href.StartsWith("mailto:"))
            {
                linkAllowed = true;
            }
            else if (Uri.TryCreate(href, UriKind.Absolute, out var u))
            {
                // allow if host matches whitelist
                foreach (var ah in allowedHosts)
                {
                    if (u.Host.Equals(ah, StringComparison.OrdinalIgnoreCase) || u.Host.EndsWith("." + ah, StringComparison.OrdinalIgnoreCase))
                    {
                        linkAllowed = true;
                        break;
                    }
                }
            }
        }
    }

    <h6 class="card-subtitle mb-2 text-muted" title="@Model.Contact">
        @if (!string.IsNullOrWhiteSpace(contactRaw) && linkAllowed && !string.IsNullOrEmpty(href))
        {
            <a href="@href" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;color:inherit;">
                @* Messenger icon (simple chat bubble with lightning) *@
                <svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" role="img">
                    <!-- Refined messenger-style icon: blue chat bubble with white bolt -->
                    <path fill="#0084FF" d="M12 2C6.48 2 2 5.58 2 10c0 2.31 1.18 4.38 3.16 5.84V22l3.01-1.64C10.07 20.64 11.01 21 12 21c5.52 0 10-3.58 10-9s-4.48-10-10-10z"/>
                    <path fill="#fff" d="M9.5 13.5L11 10.5l2.5 3.5L13 11.5 9.5 15.5l.0-.0z" />
                    <!-- The bolt path is simplified and intentionally lightweight to avoid complex vectors -->
                </svg>
                <span>@Html.Raw(contactDisplay)</span>
            </a>
        }
        else if (!string.IsNullOrWhiteSpace(contactRaw))
        {
            @Html.Raw(contactDisplay)
        }
        else
        {
            @Html.Raw("—")
        }
    </h6>

    <p class="card-text" title="Pickup: @Model.Pickup; Dropoff: @Model.Dropoff">
      <strong>Pickup:</strong> @Html.Encode(Model.Pickup) <span class="mx-1">|</span>
      <strong>Dropoff:</strong> @Html.Encode(Model.Dropoff) <br />
      <strong>Trip Date:</strong> @(Model.Date?.ToString("yyyy-MM-dd") ?? "—")
      @if (Model.Time != null) { <text> @Model.Time.Value.ToString(@"hh\:mm")</text> }
    </p>

    <div class="text-muted small" title="@Model.CreatedAt.ToLocalTime().ToString("g")">
      Requested: @Model.CreatedAt.ToLocalTime().ToString("g")
    </div>
  </div>
</div>
